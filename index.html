<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>EwuPro App</title>
  
  <!-- 1. Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  
  <!-- 2. Tailwind Config (for Inter font) -->
  <script>
    tailwind.config = {
      theme: {
        extend: {
          fontFamily: {
            sans: ['Inter', 'sans-serif'],
          },
        },
      },
    }
  </script>
  
  <!-- 3. React & ReactDOM -->
  <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  
  <!-- 4. Babel (for JSX) -->
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  
  <style>
    /* Custom scrollbar for desktop */
    ::-webkit-scrollbar { width: 6px; }
    ::-webkit-scrollbar-track { background: #f1f1f1; }
    ::-webkit-scrollbar-thumb { background: #c5c5c5; border-radius: 10px; }
    ::-webkit-scrollbar-thumb:hover { background: #a8a8a8; }
    
    /* Hide native date picker icon */
    input[type="date"]::-webkit-calendar-picker-indicator {
      display: none;
      -webkit-appearance: none;
    }
  </style>
</head>
<body class="bg-gray-100">

  <!-- The React app will mount here -->
  <div id="root"></div>

  <!-- 5. Firebase JS SDKs -->
  <script type="module">
    // Make Firebase functions available globally
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { 
      getFirestore, doc, getDoc, addDoc, setDoc, updateDoc, deleteDoc, 
      onSnapshot, collection, query, where, getDocs, writeBatch, serverTimestamp,
      setLogLevel
    } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
    
    window.firebase = {
      initializeApp,
      getAuth,
      signInAnonymously,
      signInWithCustomToken,
      onAuthStateChanged,
      getFirestore,
      doc, getDoc, addDoc, setDoc, updateDoc, deleteDoc,
      onSnapshot, collection, query, where, getDocs, writeBatch, serverTimestamp,
      setLogLevel
    };
  </script>

  <!-- 6. The React Application Code -->
  <!-- This MUST be type="text/babel" -->
  <script type="text/babel">
    
    // --- React Setup ---
    const { 
      useState, useEffect, useRef, useMemo, useCallback 
    } = React;
    const { createRoot } = ReactDOM;

    // --- Firebase Setup ---
    // Destructure functions from the global window.firebase object
    const {
      initializeApp,
      getAuth,
      signInAnonymously,
      signInWithCustomToken,
      onAuthStateChanged,
      getFirestore,
      doc, getDoc, addDoc, setDoc, updateDoc, deleteDoc,
      onSnapshot, collection, query, where, getDocs, writeBatch, serverTimestamp,
      setLogLevel
    } = window.firebase;

    // --- Firebase Initialization ---
    // These globals are provided by the app environment
    const appId = typeof __app_id !== 'undefined' ? __app_id : 'ewupro-app-dev';
    const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
    const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);
    setLogLevel('debug');

    // --- Icon Component ---
    // Using inline SVGs for Lucide icons
    const Icon = ({ name, size = 24, className = "" }) => {
      const icons = {
        Home: (<svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="m3 9 9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path><polyline points="9 22 9 12 15 12 15 22"></polyline></svg>),
        BarChart2: (<svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><line x1="18" x2="18" y1="20" y2="10"></line><line x1="12" x2="12" y1="20" y2="4"></line><line x1="6" x2="6" y1="20" y2="14"></line></svg>),
        Settings: (<svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 1 1.72v.51a2 2 0 0 1-1 1.74l-.15.09a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.38a2 2 0 0 0-.73-2.73l-.15-.1a2 2 0 0 1-1-1.72v-.51a2 2 0 0 1 1-1.74l.15-.09a2 2 0 0 0 .73-2.73l-.22-.38a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z"></path><circle cx="12" cy="12" r="3"></circle></svg>),
        Search: (<svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="11" cy="11" r="8"></circle><line x1="21" x2="16.65" y1="21" y2="16.65"></line></svg>),
        Plus: (<svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><line x1="12" x2="12" y1="5" y2="19"></line><line x1="5" x2="19" y1="12" y2="12"></line></svg>),
        Clock: (<svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="12" cy="12" r="10"></circle><polyline points="12 6 12 12 16 14"></polyline></svg>),
        ChevronDown: (<svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polyline points="6 9 12 15 18 9"></polyline></svg>),
        Trash2: (<svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path><line x1="10" x2="10" y1="11" y2="17"></line><line x1="14" x2="14" y1="11" y2="17"></line></svg>),
        Bell: (<svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"></path><path d="M13.73 21a2 2 0 0 1-3.46 0"></path></svg>),
        User: (<svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path><circle cx="12" cy="7" r="4"></circle></svg>),
        LogOut: (<svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path><polyline points="16 17 21 12 16 7"></polyline><line x1="21" x2="9" y1="12" y2="12"></line></svg>),
        ChevronLeft: (<svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polyline points="15 18 9 12 15 6"></polyline></svg>),
        ChevronRight: (<svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polyline points="9 18 15 12 9 6"></polyline></svg>),
        X: (<svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><line x1="18" x2="6" y1="6" y2="18"></line><line x1="6" x2="18" y1="6" y2="18"></line></svg>),
        Download: (<svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="7 10 12 15 17 10"></polyline><line x1="12" x2="12" y1="15" y2="3"></line></svg>),
        AlertTriangle: (<svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="m21.73 18-8-14a2 2 0 0 0-3.46 0l-8 14A2 2 0 0 0 4 21h16a2 2 0 0 0 1.73-3Z"></path><line x1="12" x2="12" y1="9" y2="13"></line><line x1="12" x2="12.01" y1="17" y2="17"></line></svg>),
        Copy: (<svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><rect width="14" height="14" x="8" y="8" rx="2" ry="2"></rect><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"></path></svg>),
        Rss: (<svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M4 11a9 9 0 0 1 9 9"></path><path d="M4 4a16 16 0 0 1 16 16"></path><circle cx="5" cy="19" r="1"></circle></svg>),
      };
      return <span className={className}>{icons[name] || null}</span>;
    };

    // --- Helper Functions ---
    const getMonthYear = (isoDate) => {
      const date = new Date(isoDate);
      return date.toLocaleString('default', { month: 'long', year: 'numeric' });
    };

    const getDayMonthYear = (isoDate) => {
      const date = new Date(isoDate);
      return date.toLocaleString('default', { day: 'numeric', month: 'long', year: 'numeric' });
    };
    
    const getISODate = (date) => {
      return date.toISOString().split('T')[0];
    };

    const formatTime = (totalMinutes) => {
      if (isNaN(totalMinutes) || totalMinutes === 0) return '0m';
      const hours = Math.floor(totalMinutes / 60);
      const minutes = totalMinutes % 60;
      let str = '';
      if (hours > 0) str += `${hours}h `;
      if (minutes > 0) str += `${minutes}m`;
      return str.trim();
    };

    // --- Component Order Fix: Define All Helper Components First ---

    /**
     * Header Component
     */
    const Header = ({ currentPage, onNavClick }) => {
      const navButton = (page, icon, label) => {
        const isActive = currentPage === page;
        return (
          <button
            onClick={() => onNavClick(page)}
            className={`flex flex-col sm:flex-row items-center justify-center gap-1 sm:gap-2 px-4 py-2 rounded-lg transition-all ${
              isActive
                ? 'bg-blue-600 text-white'
                : 'bg-white text-gray-700 hover:bg-gray-100'
            }`}
          >
            <Icon name={icon} size={20} />
            <span className="text-sm sm:text-base font-medium hidden sm:inline">{label}</span>
          </button>
        );
      };

      return (
        <header className="bg-white shadow-md sticky top-0 z-40">
          <div className="max-w-5xl mx-auto p-4 flex justify-between items-center">
            <h1 className="text-2xl font-bold text-blue-700">EwuPro</h1>
            <nav className="flex gap-2">
              {navButton('log', 'Home', 'Home')}
              {navButton('stats', 'BarChart2', 'Stats')}
              {navButton('admin', 'Settings', 'Admin')}
            </nav>
          </div>
        </header>
      );
    };

    /**
     * Time Picker Modal Component
     */
    const TimePickerModal = ({ log, onClose, onSave }) => {
      const [hours, setHours] = useState(Math.floor(log.totalMinutes / 60));
      const [minutes, setMinutes] = useState(log.totalMinutes % 60);

      const handleSave = () => {
        const total = (parseInt(hours) * 60) + parseInt(minutes);
        onSave(total);
        onClose();
      };

      return (
        <div className="fixed inset-0 bg-black bg-opacity-50 flex justify-center items-center z-50 p-4">
          <div className="bg-white rounded-2xl shadow-2xl p-6 w-full max-w-sm">
            <h3 className="text-xl font-semibold text-center mb-4">{log.projectName}</h3>
            <div className="flex justify-center gap-4 mb-6">
              {/* Hours */}
              <div>
                <label htmlFor="hours" className="block text-sm font-medium text-gray-500 mb-1 text-center">Hours</label>
                <select
                  id="hours"
                  value={hours}
                  onChange={(e) => setHours(e.target.value)}
                  className="text-2xl p-3 border border-gray-300 rounded-lg bg-white focus:outline-none focus:ring-2 focus:ring-blue-500"
                >
                  {[...Array(24).keys()].map(h => <option key={h} value={h}>{h}</option>)}
                </select>
              </div>
              {/* Minutes */}
              <div>
                <label htmlFor="minutes" className="block text-sm font-medium text-gray-500 mb-1 text-center">Minutes</label>
                <select
                  id="minutes"
                  value={minutes}
                  onChange={(e) => setMinutes(e.target.value)}
                  className="text-2xl p-3 border border-gray-300 rounded-lg bg-white focus:outline-none focus:ring-2 focus:ring-blue-500"
                >
                  <option value="0">0</option>
                  <option value="15">15</option>
                  <option value="30">30</option>
                  <option value="45">45</option>
                </select>
              </div>
            </div>
            <div className="flex gap-3">
              <button
                onClick={onClose}
                className="flex-1 p-3 bg-gray-200 text-gray-700 font-semibold rounded-lg hover:bg-gray-300 transition-all"
              >
                Cancel
              </button>
              <button
                onClick={handleSave}
                className="flex-1 p-3 bg-blue-600 text-white font-semibold rounded-lg hover:bg-blue-700 transition-all"
              >
                Save Time
              </button>
            </div>
          </div>
        </div>
      );
    };

    /**
     * Date Picker Modal Component
     */
    const DatePickerModal = ({ selectedDate, onClose, onSave }) => {
      const [currentMonth, setCurrentMonth] = useState(new Date(selectedDate + 'T12:00:00'));

      const getDaysInMonth = (date) => {
        const year = date.getFullYear();
        const month = date.getMonth();
        const firstDay = new Date(year, month, 1).getDay();
        const daysInMonth = new Date(year, month + 1, 0).getDate();
        
        let days = [];
        for (let i = 0; i < firstDay; i++) {
          days.push(null); // Blanks for start of month
        }
        for (let i = 1; i <= daysInMonth; i++) {
          days.push(new Date(year, month, i));
        }
        return days;
      };

      const [days, setDays] = useState(getDaysInMonth(currentMonth));

      const changeMonth = (offset) => {
        const newMonth = new Date(currentMonth.setMonth(currentMonth.getMonth() + offset));
        setCurrentMonth(newMonth);
        setDays(getDaysInMonth(newMonth));
      };

      const handleDayClick = (day) => {
        if (!day) return;
        onSave(getISODate(day));
        onClose();
      };

      const isSelected = (day) => {
        if (!day) return false;
        return getISODate(day) === selectedDate;
      };

      const isToday = (day) => {
        if (!day) return false;
        return getISODate(day) === getISODate(new Date());
      };

      return (
        <div className="fixed inset-0 bg-black bg-opacity-50 flex justify-center items-center z-50 p-4">
          <div className="bg-white rounded-2xl shadow-2xl p-6 w-full max-w-sm">
            <div className="flex justify-between items-center mb-4">
              <button onClick={() => changeMonth(-1)} className="p-2 rounded-full hover:bg-gray-100">
                <Icon name="ChevronLeft" size={20} />
              </button>
              <h3 className="text-lg font-semibold">
                {currentMonth.toLocaleString('default', { month: 'long', year: 'numeric' })}
              </h3>
              <button onClick={() => changeMonth(1)} className="p-2 rounded-full hover:bg-gray-100">
                <Icon name="ChevronRight" size={20} />
              </button>
            </div>
            
            <div className="grid grid-cols-7 gap-1 text-center">
              {['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'].map(day => (
                <div key={day} className="text-xs font-medium text-gray-500">{day}</div>
              ))}
              
              {days.map((day, index) => (
                <button
                  key={index}
                  onClick={() => handleDayClick(day)}
                  disabled={!day}
                  className={`h-10 w-10 rounded-full transition-all ${
                    !day ? 'bg-transparent' : 'hover:bg-gray-100'
                  } ${
                    isToday(day) ? 'font-bold text-blue-600' : ''
                  } ${
                    isSelected(day) ? '!bg-blue-600 !text-white' : ''
                  }`}
                >
                  {day ? day.getDate() : ''}
                </button>
              ))}
            </div>
            
            <button
              onClick={onClose}
              className="w-full mt-4 p-3 bg-gray-200 text-gray-700 font-semibold rounded-lg hover:bg-gray-300 transition-all"
            >
              Cancel
            </button>
          </div>
        </div>
      );
    };

    /**
     * Delete Confirmation Modal
     */
    const DeleteConfirmationModal = ({ log, onClose, onConfirm }) => {
      return (
        <div className="fixed inset-0 bg-black bg-opacity-50 flex justify-center items-center z-50 p-4">
          <div className="bg-white rounded-2xl shadow-2xl p-6 w-full max-w-sm">
            <div className="text-center">
              <div className="w-16 h-16 bg-red-100 rounded-full flex items-center justify-center mx-auto mb-4">
                <Icon name="AlertTriangle" size={32} className="text-red-600" />
              </div>
              <h3 className="text-xl font-semibold text-gray-900 mb-2">Delete Log?</h3>
              <p className="text-gray-500 mb-6">
                Are you sure you want to delete the log for <strong className="text-gray-700">{log.projectName}</strong> on {getDayMonthYear(log.date)}?
              </p>
            </div>
            <div className="flex gap-3">
              <button
                onClick={onClose}
                className="flex-1 p-3 bg-gray-200 text-gray-700 font-semibold rounded-lg hover:bg-gray-300 transition-all"
              >
                Cancel
              </button>
              <button
                onClick={() => onConfirm(log.id)}
                className="flex-1 p-3 bg-red-600 text-white font-semibold rounded-lg hover:bg-red-700 transition-all"
              >
                Confirm Delete
              </button>
            </div>
          </div>
        </div>
      );
    };

    /**
     * CsvExportModal Component
     */
    const CsvExportModal = ({ csvData, onClose }) => {
      con
